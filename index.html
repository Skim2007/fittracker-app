<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitTracker Pro">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%234f46e5'/%3E%3Ctext y='70' font-size='50' text-anchor='middle' x='50' fill='white'%3E‚ö°%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRml0VHJhY2tlciBQcm8iLCJzaG9ydF9uYW1lIjoiRml0VHJhY2tlciIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjNGY0NmU1IiwidGhlbWVfY29sb3IiOiIjNGY0NmU1IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyByeD0nMjAnIGZpbGw9JyUyMzRmNDZlNScvJTNFJTNJdGV4dCB5PSc3MCcgZm9udC1zaXplPSc1MCcgdGV4dC1hbmNob3I9J21pZGRsZScgeD0nNTAnIGZpbGw9J3doaXRlJyUzRSVFMiU4MiVBMSUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <title>FitTracker Pro</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #7c3aed;
            --background: #f3f4f6;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text: #1f2937;
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --background: #1a1a1a;
            --card-bg: rgba(45, 45, 45, 0.95);
            --text: #f3f4f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            max-width: 100%;
            padding: 1rem;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: var(--text);
            padding: 1.5rem 0;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
        }

        .card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        input, select {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        button {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f472b6, #f9a8d4);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .progress-bar {
            width: 100%;
            height: 1rem;
            background: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
        }

        .bmi-indicator {
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            margin-top: 1rem;
        }

        .bmi-underweight { background: #60a5fa; color: white; }
        .bmi-normal { background: #10b981; color: white; }
        .bmi-overweight { background: #facc15; color: #1f2937; }
        .bmi-obese { background: #ef4444; color: white; }

        .macros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .macro-card {
            background: linear-gradient(135deg, #34d399, #6ee7b7);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            color: white;
        }

        .macro-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .goal-prediction {
            background: linear-gradient(135deg, #a5f3fc, #e879f9);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-top: 1rem;
        }

        .water-tracker {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .water-progress {
            text-align: center;
            font-size: 1rem;
            color: var(--text);
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.3s ease;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
        }

        .hidden {
            display: none;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                padding: 2rem;
            }

            .setup-form {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .header h1 {
                font-size: 2.5rem;
            }

            .nav-bar {
                display: none;
            }
        }

        @media (max-width: 375px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .macros-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    <div class="container">
        <div class="header">
            <h1>‚ö° FitTracker Pro</h1>
            <p>Il tuo calcolatore fitness definitivo</p>
        </div>

        <!-- Setup iniziale -->
        <div id="setupSection" class="card">
            <h2>üîß Configura il tuo Profilo</h2>
            <div class="setup-form">
                <div class="form-group">
                    <label for="name">Nome:</label>
                    <input type="text" id="name" placeholder="Il tuo nome" required>
                </div>
                <div class="form-group">
                    <label for="age">Et√†:</label>
                    <input type="number" id="age" min="13" max="100" placeholder="Anni" required>
                </div>
                <div class="form-group">
                    <label for="height">Altezza (cm):</label>
                    <input type="number" id="height" min="100" max="250" placeholder="Centimetri" required>
                </div>
                <div class="form-group">
                    <label for="weight">Peso (kg):</label>
                    <input type="number" id="weight" min="30" max="300" step="0.1" placeholder="Chilogrammi" required>
                </div>
                <div class="form-group">
                    <label for="bodyFat">Percentuale Massa Grassa (%):</label>
                    <input type="number" id="bodyFat" min="5" max="50" step="0.1" placeholder="Facoltativo">
                </div>
                <div class="form-group">
                    <label for="gender">Sesso:</label>
                    <select id="gender" required>
                        <option value="male">Maschio</option>
                        <option value="female">Femmina</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="goal">Obiettivo:</label>
                    <select id="goal" required>
                        <option value="lose">Perdere Peso</option>
                        <option value="gain">Aumentare Massa</option>
                        <option value="maintain">Mantenere Forma</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="targetWeight">Peso Obiettivo (kg):</label>
                    <input type="number" id="targetWeight" min="30" max="300" step="0.1" placeholder="Peso desiderato" required>
                </div>
                <div class="form-group">
                    <label for="activityLevel">Livello Attivit√†:</label>
                    <select id="activityLevel" required>
                        <option value="sedentary">Sedentario</option>
                        <option value="light">Leggero</option>
                        <option value="moderate">Moderato</option>
                        <option value="active">Attivo</option>
                        <option value="extra">Estremamente Attivo</option>
                    </select>
                </div>
            </div>
            <button onclick="saveProfile()">üíæ Salva Profilo</button>
        </div>

        <!-- Dashboard principale -->
        <div id="dashboardSection" class="card hidden">
            <h2>üìä Le Tue Statistiche</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="currentWeight">0 kg</div>
                    <div>Peso Attuale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bmiValue">0</div>
                    <div>BMI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bodyFatValue">N/D</div>
                    <div>Massa Grassa</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tdeeValue">0 kcal</div>
                    <div>TDEE</div>
                </div>
            </div>
            <div id="bmiIndicator" class="bmi-indicator"></div>
        </div>

        <!-- Macros -->
        <div id="macrosSection" class="card hidden">
            <h2>üçΩÔ∏è Macros Consigliati</h2>
            <div class="macros-grid">
                <div class="macro-card">
                    <div class="macro-value" id="proteinGrams">0g</div>
                    <div>Proteine</div>
                </div>
                <div class="macro-card">
                    <div class="macro-value" id="carbGrams">0g</div>
                    <div>Carboidrati</div>
                </div>
                <div class="macro-card">
                    <div class="macro-value" id="fatGrams">0g</div>
                    <div>Grassi</div>
                </div>
            </div>
        </div>

        <!-- Progresso -->
        <div id="progressSection" class="card hidden">
            <h2>üéØ Progresso Obiettivo</h2>
            <div id="progressText"></div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="goalPrediction" class="goal-prediction"></div>
            <canvas id="weightChart" style="margin-top: 1rem;"></canvas>
        </div>

        <!-- Acqua -->
        <div id="waterSection" class="card hidden">
            <h2>üíß Tracciamento Acqua</h2>
            <div class="water-tracker">
                <div class="form-group">
                    <label for="waterGoal">Obiettivo Acqua (ml):</label>
                    <input type="number" id="waterGoal" min="500" max="5000" step="100" placeholder="es. 2000">
                </div>
                <div class="form-group">
                    <label for="waterIntake">Aggiungi Acqua (ml):</label>
                    <input type="number" id="waterIntake" min="100" max="1000" step="100" placeholder="es. 250">
                </div>
                <button onclick="addWater()">‚ûï Aggiungi</button>
                <div class="water-progress" id="waterProgress">0 ml / 0 ml</div>
            </div>
        </div>

        <!-- Aggiorna Peso -->
        <div id="updateWeightSection" class="card hidden">
            <h2>‚öñÔ∏è Aggiorna Peso</h2>
            <div class="form-group">
                <label for="newWeight">Nuovo Peso (kg):</label>
                <input type="number" id="newWeight" min="30" max="300" step="0.1" placeholder="Peso attuale">
            </div>
            <div class="form-group">
                <label for="newBodyFat">Nuova % Massa Grassa (facoltativa):</label>
                <input type="number" id="newBodyFat" min="5" max="50" step="0.1" placeholder="Facoltativo">
            </div>
            <button onclick="updateWeight()">üìà Aggiorna</button>
        </div>

        <!-- Impostazioni -->
        <div id="settingsSection" class="card hidden">
            <h2>‚öôÔ∏è Impostazioni</h2>
            <button onclick="resetData()" style="background: #ef4444;">üóëÔ∏è Reset Dati</button>
            <button onclick="exportData()" style="background: #10b981; margin-top: 1rem;">üì§ Esporta Dati</button>
        </div>

        <!-- Navigazione -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="showSection('dashboardSection')">
                <span>üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('macrosSection')">
                <span>üçΩÔ∏è</span>
                <span>Macros</span>
            </div>
            <div class="nav-item" onclick="showSection('progressSection')">
                <span>üéØ</span>
                <span>Progresso</span>
            </div>
            <div class="nav-item" onclick="showSection('waterSection')">
                <span>üíß</span>
                <span>Acqua</span>
            </div>
            <div class="nav-item" onclick="showSection('updateWeightSection')">
                <span>‚öñÔ∏è</span>
                <span>Peso</span>
            </div>
            <div class="nav-item" onclick="showSection('settingsSection')">
                <span>‚öôÔ∏è</span>
                <span>Impostazioni</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script>
        // Variabili globali
        let userData = {};
        let weightHistory = [];
        let waterIntake = 0;
        let waterGoal = 2000;
        let weightChart;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Caricamento app...');
            loadData();
            if (isProfileComplete()) {
                showSection('dashboardSection');
                updateStats();
                initializeChart();
            } else {
                showSection('setupSection');
            }
            applyTheme();
            requestNotificationPermission();
        });

        // Gestione tema
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Notifiche
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }
        }

        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('FitTracker Pro', { body: message });
            }
        }

        // Gestione sezioni
        function showSection(sectionId) {
            console.log('Mostra sezione:', sectionId);
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="showSection('${sectionId}')"]`).classList.add('active');
            if (sectionId === 'dashboardSection' || sectionId === 'macrosSection' || sectionId === 'progressSection') {
                updateStats();
            }
        }

        // Gestione profilo
        function saveProfile() {
            console.log('Salvataggio profilo...');
            const name = document.getElementById('name').value.trim();
            const age = parseInt(document.getElementById('age').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const bodyFat = parseFloat(document.getElementById('bodyFat').value) || null;
            const gender = document.getElementById('gender').value;
            const goal = document.getElementById('goal').value;
            const targetWeight = parseFloat(document.getElementById('targetWeight').value) || 0;
            const activityLevel = document.getElementById('activityLevel').value;

            if (!name || !age || !height || !weight || !targetWeight) {
                alert('Compila tutti i campi obbligatori!');
                console.error('Campi obbligatori mancanti:', { name, age, height, weight, targetWeight });
                return;
            }

            if (age < 13 || age > 100) {
                alert('L\'et√† deve essere compresa tra 13 e 100 anni.');
                console.error('Et√† non valida:', age);
                return;
            }

            if (height < 100 || height > 250) {
                alert('L\'altezza deve essere compresa tra 100 e 250 cm.');
                console.error('Altezza non valida:', height);
                return;
            }

            if (weight < 30 || weight > 300 || targetWeight < 30 || targetWeight > 300) {
                alert('Il peso e il peso obiettivo devono essere compresi tra 30 e 300 kg.');
                console.error('Peso non valido:', { weight, targetWeight });
                return;
            }

            if (bodyFat && (bodyFat < 5 || bodyFat > 50)) {
                alert('La percentuale di massa grassa deve essere compresa tra 5% e 50%.');
                console.error('Percentuale massa grassa non valida:', bodyFat);
                return;
            }

            userData = {
                name,
                age,
                height,
                weight,
                bodyFat,
                gender,
                goal,
                targetWeight,
                activityLevel,
                startDate: new Date().toISOString(),
                startWeight: weight
            };

            weightHistory = [{ weight, bodyFat, date: new Date().toISOString() }];
            saveData();
            showSection('dashboardSection');
            updateStats();
            initializeChart();
            showNotification('Profilo salvato con successo!');
            console.log('Profilo salvato:', userData);
        }

        function isProfileComplete() {
            const complete = userData && userData.name && userData.age && userData.height && userData.weight && userData.targetWeight;
            console.log('Profilo completo:', complete);
            return complete;
        }

        // Gestione peso
        function updateWeight() {
            console.log('Aggiornamento peso...');
            const newWeight = parseFloat(document.getElementById('newWeight').value) || 0;
            const newBodyFat = parseFloat(document.getElementById('newBodyFat').value) || null;

            if (!newWeight || newWeight < 30 || newWeight > 300) {
                alert('Inserisci un peso valido (30-300 kg)!');
                console.error('Peso non valido:', newWeight);
                return;
            }

            if (newBodyFat && (newBodyFat < 5 || newBodyFat > 50)) {
                alert('La percentuale di massa grassa deve essere compresa tra 5% e 50%.');
                console.error('Percentuale massa grassa non valida:', newBodyFat);
                return;
            }

            userData.weight = newWeight;
            userData.bodyFat = newBodyFat;
            weightHistory.push({
                weight: newWeight,
                bodyFat: newBodyFat,
                date: new Date().toISOString()
            });

            saveData();
            updateStats();
            updateChart();
            document.getElementById('newWeight').value = '';
            document.getElementById('newBodyFat').value = '';
            showNotification('Peso aggiornato!');
            console.log('Peso aggiornato:', { newWeight, newBodyFat });
        }

        // Tracciamento acqua
        function addWater() {
            console.log('Aggiunta acqua...');
            const intake = parseInt(document.getElementById('waterIntake').value) || 0;
            const goal = parseInt(document.getElementById('waterGoal').value) || waterGoal;

            if (intake <= 0 || intake > 1000) {
                alert('Inserisci una quantit√† di acqua valida (100-1000 ml)!');
                console.error('Quantit√† acqua non valida:', intake);
                return;
            }

            if (goal < 500 || goal > 5000) {
                alert('L\'obiettivo acqua deve essere compreso tra 500 e 5000 ml.');
                console.error('Obiettivo acqua non valido:', goal);
                return;
            }

            waterGoal = goal;
            waterIntake += intake;
            saveData();
            updateWaterProgress();
            document.getElementById('waterIntake').value = '';

            if (waterIntake >= waterGoal) {
                showNotification('Obiettivo acqua raggiunto! üéâ');
            }
            console.log('Acqua aggiunta:', { intake, waterIntake, waterGoal });
        }

        function updateWaterProgress() {
            const progress = document.getElementById('waterProgress');
            progress.textContent = `${waterIntake} ml / ${waterGoal} ml`;
            progress.style.color = waterIntake >= waterGoal ? '#10b981' : 'var(--text)';
        }

        // Calcoli
        function calculateBMI() {
            if (!userData.height || !userData.weight) return 0;
            const heightM = userData.height / 100;
            return (userData.weight / (heightM * heightM)).toFixed(1);
        }

        function getBMICategory(bmi) {
            if (bmi < 18.5) return { category: 'underweight', text: 'Sottopeso' };
            if (bmi < 25) return { category: 'normal', text: 'Normopeso' };
            if (bmi < 30) return { category: 'overweight', text: 'Sovrappeso' };
            return { category: 'obese', text: 'Obeso' };
        }

        function calculateBMR() {
            const { weight, height, age, gender, bodyFat } = userData;
            if (!weight || !height || !age) return 0;
            if (bodyFat) {
                const lbm = weight * (1 - bodyFat / 100);
                return 370 + 21.6 * lbm;
            }
            if (gender === 'male') {
                return 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                return 10 * weight + 6.25 * height - 5 * age - 161;
            }
        }

        function calculateTDEE(bmr) {
            if (!bmr) return 0;
            const activityFactors = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                active: 1.725,
                extra: 1.9
            };
            return Math.round(bmr * (activityFactors[userData.activityLevel] || 1.2));
        }

        function calculateMacros(tdee) {
            if (!tdee) return { protein: 0, carbs: 0, fats: 0 };
            let proteinRatio, carbRatio, fatRatio;
            switch (userData.goal) {
                case 'lose':
                    proteinRatio = 0.35;
                    carbRatio = 0.35;
                    fatRatio = 0.30;
                    break;
                case 'gain':
                    proteinRatio = 0.30;
                    carbRatio = 0.50;
                    fatRatio = 0.20;
                    break;
                default:
                    proteinRatio = 0.30;
                    carbRatio = 0.40;
                    fatRatio = 0.30;
            }
            return {
                protein: Math.round((tdee * proteinRatio) / 4),
                carbs: Math.round((tdee * carbRatio) / 4),
                fats: Math.round((tdee * fatRatio) / 9)
            };
        }

        function calculateProgress() {
            if (!userData.startWeight || !userData.weight || !userData.targetWeight) return 0;
            const totalChange = Math.abs(userData.startWeight - userData.targetWeight);
            const currentChange = Math.abs(userData.startWeight - userData.weight);
            return Math.min(100, Math.max(0, (currentChange / totalChange) * 100)).toFixed(1);
        }

        function calculateGoalPrediction() {
            if (!userData.weight || !userData.targetWeight) return { weeks: 0, months: 0, recommendation: '' };
            const weightDiff = Math.abs(userData.weight - userData.targetWeight);
            const isLosing = userData.weight > userData.targetWeight;
            const weeksNeeded = isLosing ? Math.ceil(weightDiff / 0.5) : Math.ceil(weightDiff / 0.3);
            return {
                weeks: weeksNeeded,
                months: Math.ceil(weeksNeeded / 4),
                recommendation: getRecommendation()
            };
        }

        function getRecommendation() {
            switch (userData.goal) {
                case 'lose':
                    return 'Mantieni un deficit calorico di 500-750 kcal/giorno con un mix di cardio e forza.';
                case 'gain':
                    return 'Segui un surplus calorico di 300-500 kcal/giorno con allenamenti di forza.';
                default:
                    return 'Bilancia allenamenti di forza e cardio con un apporto calorico equilibrato.';
            }
        }

        function updateStats() {
            console.log('Aggiornamento statistiche:', userData);
            if (!isProfileComplete()) {
                console.warn('Profilo incompleto, statistiche non aggiornate');
                return;
            }

            const bmi = calculateBMI();
            const bmr = calculateBMR();
            const tdee = calculateTDEE(bmr);
            const macros = calculateMacros(tdee);
            const progress = calculateProgress();
            const prediction = calculateGoalPrediction();
            const bmiCategory = getBMICategory(parseFloat(bmi));

            document.getElementById('currentWeight').textContent = `${userData.weight || 0} kg`;
            document.getElementById('bmiValue').textContent = bmi || 'N/D';
            document.getElementById('bodyFatValue').textContent = userData.bodyFat ? `${userData.bodyFat}%` : 'N/D';
            document.getElementById('tdeeValue').textContent = tdee ? `${tdee} kcal` : 'N/D';
            document.getElementById('bmiIndicator').textContent = bmi ? `BMI: ${bmi} - ${bmiCategory.text}` : 'BMI: N/D';
            document.getElementById('bmiIndicator').className = `bmi-indicator${bmi ? ` bmi-${bmiCategory.category}` : ''}`;
            document.getElementById('proteinGrams').textContent = `${macros.protein || 0}g`;
            document.getElementById('carbGrams').textContent = `${macros.carbs || 0}g`;
            document.getElementById('fatGrams').textContent = `${macros.fats || 0}g`;
            document.getElementById('progressText').textContent = `Progresso verso l'obiettivo: ${progress || 0}%`;
            document.getElementById('progressFill').style.width = `${progress || 0}%`;
            document.getElementById('goalPrediction').innerHTML = `
                <h3>üéØ Previsione</h3>
                <p><strong>Tempo stimato:</strong> ${prediction.weeks} settimane (~${prediction.months} mesi)</p>
                <p><strong>Consiglio:</strong> ${prediction.recommendation}</p>
            `;
            updateWaterProgress();
            console.log('Statistiche aggiornate:', { bmi, tdee, macros, progress });
        }

        // Grafico
        function initializeChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Peso (kg)',
                        data: [],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Data' } },
                        y: { title: { display: true, text: 'Peso (kg)' } }
                    }
                }
            });
            updateChart();
        }

        function updateChart() {
            if (!weightChart) return;
            const labels = weightHistory.map(entry => new Date(entry.date).toLocaleDateString('it-IT'));
            const data = weightHistory.map(entry => entry.weight);
            weightChart.data.labels = labels;
            weightChart.data.datasets[0].data = data;
            weightChart.update();
            console.log('Grafico aggiornato:', { labels, data });
        }

        // Gestione dati
        function saveData() {
            try {
                localStorage.setItem('fitTracker_userData', JSON.stringify(userData));
                localStorage.setItem('fitTracker_weightHistory', JSON.stringify(weightHistory));
                localStorage.setItem('fitTracker_waterIntake', JSON.stringify({ intake: waterIntake, goal: waterGoal, date: new Date().toDateString() }));
                console.log('Dati salvati:', { userData, weightHistory, waterIntake, waterGoal });
            } catch (error) {
                console.error('Errore nel salvataggio dei dati:', error);
                alert('Errore nel salvataggio dei dati. Verifica lo spazio disponibile.');
            }
        }

        function loadData() {
            try {
                const savedUserData = localStorage.getItem('fitTracker_userData');
                const savedWeightHistory = localStorage.getItem('fitTracker_weightHistory');
                const savedWater = localStorage.getItem('fitTracker_waterIntake');

                if (savedUserData) {
                    userData = JSON.parse(savedUserData);
                    document.getElementById('name').value = userData.name || '';
                    document.getElementById('age').value = userData.age || '';
                    document.getElementById('height').value = userData.height || '';
                    document.getElementById('weight').value = userData.weight || '';
                    document.getElementById('bodyFat').value = userData.bodyFat || '';
                    document.getElementById('gender').value = userData.gender || 'male';
                    document.getElementById('goal').value = userData.goal || 'maintain';
                    document.getElementById('targetWeight').value = userData.targetWeight || '';
                    document.getElementById('activityLevel').value = userData.activityLevel || 'sedentary';
                    console.log('Dati utente caricati:', userData);
                }

                if (savedWeightHistory) {
                    weightHistory = JSON.parse(savedWeightHistory);
                    console.log('Cronologia peso caricata:', weightHistory);
                }

                if (savedWater) {
                    const waterData = JSON.parse(savedWater);
                    if (waterData.date === new Date().toDateString()) {
                        waterIntake = waterData.intake || 0;
                        waterGoal = waterData.goal || 2000;
                    }
                    document.getElementById('waterGoal').value = waterGoal;
                    updateWaterProgress();
                    console.log('Dati acqua caricati:', { waterIntake, waterGoal });
                }
            } catch (error) {
                console.error('Errore nel caricamento dei dati:', error);
                userData = {};
                weightHistory = [];
                waterIntake = 0;
                waterGoal = 2000;
                document.getElementById('waterGoal').value = waterGoal;
            }
        }

        function resetData() {
            if (confirm('ATTENZIONE: Tutti i dati verranno eliminati. Confermi?')) {
                localStorage.removeItem('fitTracker_userData');
                localStorage.removeItem('fitTracker_weightHistory');
                localStorage.removeItem('fitTracker_waterIntake');
                userData = {};
                weightHistory = [];
                waterIntake = 0;
                waterGoal = 2000;
                document.getElementById('setupSection').classList.remove('hidden');
                document.querySelectorAll('.card:not(#setupSection)').forEach(card => card.classList.add('hidden'));
                document.getElementById('name').value = '';
                document.getElementById('age').value = '';
                document.getElementById('height').value = '';
                document.getElementById('weight').value = '';
                document.getElementById('bodyFat').value = '';
                document.getElementById('targetWeight').value = '';
                document.getElementById('waterGoal').value = '2000';
                if (weightChart) weightChart.destroy();
                alert('Dati eliminati con successo!');
                console.log('Dati resettati');
            }
        }

        function exportData() {
            const dataToExport = {
                userData,
                weightHistory,
                waterIntake,
                waterGoal,
                exportDate: new Date().toISOString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `fittracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            console.log('Dati esportati:', dataToExport);
        }
    </script>
</body>
</html>
